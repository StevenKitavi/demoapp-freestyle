name: Legitify Analyze
on:
  workflow_dispatch:
  schedule:
    - cron: '0 11 * * 1-5'
  push:
    branches: [ "master" ]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download and Run Legitify Manually
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_FOR_LEGITIFY }}
        run: |
          # Download Legitify
          wget https://github.com/Legit-Labs/legitify/releases/download/v1.0.11/legitify_1.0.11_linux_amd64.tar.gz
          tar -xzf legitify_1.0.11_linux_amd64.tar.gz
          chmod +x legitify
          
          # First, check what commands are available
          echo "=== LEGITIFY HELP ==="
          ./legitify --help
          
          echo "=== LEGITIFY ANALYZE HELP ==="
          ./legitify analyze --help
          
          # Run analysis without verbose flag
          echo "=== RUNNING LEGITIFY ANALYZE ==="
          ./legitify analyze --org StevenKitavi --output-format json --output-file legitify-output.json
          
          # Check what happened
          echo "=== COMMAND EXIT CODE: $? ==="
          
          # Check results
          echo "=== CHECKING RESULTS ==="
          ls -la
          if [ -f legitify-output.json ]; then
            echo "✅ Results generated!"
            echo "File size: $(wc -c < legitify-output.json) bytes"
            echo "=== RESULTS CONTENT ==="
            cat legitify-output.json
          else
            echo "❌ No output generated"
          fi
          
          # Also check for any error files
          if [ -f error.log ]; then
            echo "=== ERROR LOG ==="
            cat error.log
          fi
